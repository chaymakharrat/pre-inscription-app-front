<!-- Main Content -->
<main class="dashboard-main animate-fadeIn">
    <!-- Header -->
    <header
        class="bg-white/80 backdrop-blur-xl border-b border-[#e8eaf0] px-8 py-5 sticky top-0 z-40 flex items-center justify-between">
        <div class="flex flex-col">
            <h1 class="text-2xl font-bold text-[#0f1117] tracking-tight flex items-center gap-3">
                Dashboard Scolarité
                <span
                    class="px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-[#eff4ff] text-[#2563eb] border border-[#dbe6ff] uppercase tracking-wider">
                    Agent View
                </span>
            </h1>
            <div class="flex items-center mt-1 gap-2">
                <div class="w-1.5 h-1.5 rounded-full bg-[#f59e0b] animate-pulse"></div>
                <p class="text-[11px] font-semibold text-[#8b92a9]">
                    {{stats.enAttente}} dossiers en attente d'approbation
                </p>
            </div>
        </div>

        <div class="flex items-center gap-6">
            <!-- View Mode Switcher -->
            <div class="view-toggle">
                <button [class.active]="viewMode === 'list'" (click)="viewMode = 'list'" title="Vue liste">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M3 6h18M3 12h18M3 18h18" stroke-linecap="round" />
                    </svg>
                    Liste
                </button>
                <button [class.active]="viewMode === 'grid'" (click)="viewMode = 'grid'" title="Vue grille">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M3 3h7v7H3V3zm11 0h7v7h-7V3zm0 11h7v7h-7v-7zM3 14h7v7H3v-7z" stroke-linecap="round" />
                    </svg>
                    Grille
                </button>
            </div>

            <!-- Profile Section -->
            <div class="flex items-center pl-6 border-l border-[#e8eaf0]">
                <div class="text-right mr-4 hidden md:block">
                    <p class="text-sm font-bold text-[#0f1117] leading-tight">
                        {{userProfile?.firstName}} {{userProfile?.lastName}}
                    </p>
                    <p class="text-[10px] font-bold text-[#2563eb] uppercase tracking-widest mt-0.5">
                        {{getDisplayRole()}}
                    </p>
                </div>
                <div class="avatar-premium" [style.background]="getAvatarColor(0)">
                    {{getProfileInitials()}}
                </div>
            </div>
        </div>
    </header>

    <!-- 2. CARTES DE STATISTIQUES AMÉLIORÉES -->
    <div class="px-8 py-6">
        <!-- Indicateur de tendance global -->
        <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-600 rounded-lg flex items-center justify-between">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-blue-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                        clip-rule="evenodd" />
                </svg>
                <div>
                    <p class="text-sm font-medium text-blue-900">Activité en hausse cette semaine</p>
                    <p class="text-xs text-blue-700">+15% de nouveaux dossiers comparé à la semaine dernière</p>
                </div>
            </div>
            <span class="text-2xl font-bold text-blue-600">↗</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Carte 1 - En attente (améliorée) -->
            <div
                class="stat-card bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all cursor-pointer group">
                <div class="flex items-center justify-between mb-4">
                    <div
                        class="p-3 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl group-hover:scale-110 transition-transform">
                        <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-xs font-medium text-gray-500 uppercase mb-1">Tendance</span>
                        <span
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z"
                                    clip-rule="evenodd" />
                            </svg>
                            +5 aujourd'hui
                        </span>
                    </div>
                </div>
                <div>
                    <h3 class="text-4xl font-bold text-gray-900 mb-1 group-hover:text-blue-600 transition-colors">
                        {{stats.enAttente}}
                    </h3>
                    <p class="text-sm text-gray-600 font-medium">En attente de traitement</p>
                    <div class="mt-3 h-1 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full transition-all duration-1000"
                            [style.width.%]="(stats.enAttente / stats.total) * 100">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carte 2 - Délai moyen (améliorée) -->
            <div
                class="stat-card bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all cursor-pointer group">
                <div class="flex items-center justify-between mb-4">
                    <div
                        class="p-3 bg-gradient-to-br from-teal-50 to-teal-100 rounded-xl group-hover:scale-110 transition-transform">
                        <svg class="w-7 h-7 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-xs font-medium text-gray-500 uppercase mb-1">Évolution</span>
                        <span
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z"
                                    clip-rule="evenodd" />
                            </svg>
                            -0.3j plus rapide
                        </span>
                    </div>
                </div>
                <div>
                    <h3 class="text-4xl font-bold text-gray-900 mb-1 group-hover:text-teal-600 transition-colors">
                        {{stats.delaiMoyenTraitement}}
                    </h3>
                    <p class="text-sm text-gray-600 font-medium">Délai moyen de traitement</p>
                    <div class="mt-3 flex items-center space-x-2">
                        <div class="flex-1 h-1 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-teal-500 to-teal-600 rounded-full"
                                style="width: 75%"></div>
                        </div>
                        <span class="text-xs text-gray-500 font-medium">Cible: 1.5j</span>
                    </div>
                </div>
            </div>

            <!-- Carte 3 - Dossiers validés (améliorée) -->
            <div
                class="stat-card bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all cursor-pointer group">
                <div class="flex items-center justify-between mb-4">
                    <div
                        class="p-3 bg-gradient-to-br from-green-50 to-green-100 rounded-xl group-hover:scale-110 transition-transform">
                        <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-xs font-medium text-gray-500 uppercase mb-1">Cette semaine</span>
                        <span
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z"
                                    clip-rule="evenodd" />
                            </svg>
                            +12 validations
                        </span>
                    </div>
                </div>
                <div>
                    <h3 class="text-4xl font-bold text-gray-900 mb-1 group-hover:text-green-600 transition-colors">
                        {{stats.validees}}
                    </h3>
                    <p class="text-sm text-gray-600 font-medium">Dossiers validés</p>
                    <div class="mt-3 grid grid-cols-7 gap-1">
                        <!-- Mini graphique de la semaine -->
                        <div class="h-8 bg-green-100 rounded" [style.height.%]="60"></div>
                        <div class="h-8 bg-green-200 rounded" [style.height.%]="75"></div>
                        <div class="h-8 bg-green-300 rounded" [style.height.%]="55"></div>
                        <div class="h-8 bg-green-400 rounded" [style.height.%]="85"></div>
                        <div class="h-8 bg-green-500 rounded" [style.height.%]="70"></div>
                        <div class="h-8 bg-green-600 rounded" [style.height.%]="90"></div>
                        <div class="h-8 bg-green-700 rounded" [style.height.%]="100"></div>
                    </div>
                </div>
            </div>

            <!-- Carte 4 - Taux de validation (améliorée) -->
            <div
                class="stat-card bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all cursor-pointer group relative overflow-hidden">
                <!-- Background pattern -->
                <div class="absolute inset-0 opacity-5">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse">
                            <path d="M 10 0 L 0 0 0 10" fill="none" stroke="gray" stroke-width="0.5" />
                        </pattern>
                        <rect width="100" height="100" fill="url(#grid)" />
                    </svg>
                </div>

                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-4">
                        <div
                            class="p-3 bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl group-hover:scale-110 transition-transform">
                            <svg class="w-7 h-7 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-xs font-medium text-gray-500 uppercase mb-1">Objectif</span>
                            <span
                                class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                +3% ce mois
                            </span>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-4xl font-bold text-gray-900 mb-1 group-hover:text-orange-600 transition-colors">
                            92%
                        </h3>
                        <p class="text-sm text-gray-600 font-medium">Taux de validation</p>

                        <!-- Graphique circulaire -->
                        <div class="mt-3 flex items-center justify-between">
                            <div class="relative w-16 h-16">
                                <svg class="transform -rotate-90 w-16 h-16">
                                    <circle cx="32" cy="32" r="28" stroke="#E5E7EB" stroke-width="4" fill="none" />
                                    <circle cx="32" cy="32" r="28" stroke="#F59E0B" stroke-width="4" fill="none"
                                        stroke-dasharray="175.93" stroke-dashoffset="14" />
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-xs font-bold text-gray-700">92%</span>
                                </div>
                            </div>
                            <div class="text-xs space-y-1">
                                <div class="flex items-center">
                                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                    <span class="text-gray-600">Validés: 92%</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                                    <span class="text-gray-600">Rejetés: 5%</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
                                    <span class="text-gray-600">En cours: 3%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Main Dashboard Area -->
    <div class="px-8 mt-6">
        <div class="admin-table-wrapper">
            <!-- Search & Filter Bar -->
            <div class="p-5 border-b border-[#e8eaf0] flex flex-wrap items-center justify-between gap-4 bg-white">
                <div class="search-wrapper">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" [(ngModel)]="searchTerm" (input)="onSearch()"
                        placeholder="Rechercher un dossier...">
                </div>

                <div class="filter-tabs">
                    <button (click)="setFilter('tous')" class="filter-tab" [class.active]="currentFilter === 'tous'">
                        Tous
                    </button>
                    <button (click)="setFilter('nouveaux')" class="filter-tab"
                        [class.active]="currentFilter === 'nouveaux'">
                        Nouveaux
                    </button>
                    <button (click)="setFilter('complets')" class="filter-tab"
                        [class.active]="currentFilter === 'complets'">
                        Prêts
                    </button>
                    <button (click)="setFilter('incomplets')" class="filter-tab"
                        [class.active]="currentFilter === 'incomplets'">
                        Incomplets
                    </button>
                    <button (click)="setFilter('valides')" class="filter-tab"
                        [class.active]="currentFilter === 'valides'">
                        Validés
                    </button>
                    <button (click)="setFilter('urgents')" class="filter-tab"
                        [class.active]="currentFilter === 'urgents'">
                        Urgents
                    </button>
                </div>
            </div>

            <!-- List View (Table) -->
            <div class="overflow-x-auto" *ngIf="viewMode === 'list'">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Dossier</th>
                            <th>Étudiant</th>
                            <th>Formation</th>
                            <th>Délai</th>
                            <th>Documents</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let demande of demandes; let i = index"
                            class="animate-fadeIn hover:bg-gray-50/50 cursor-pointer"
                            (click)="openDemandeDetail(demande)" [style.animation-delay]="i * 0.05 + 's'">
                            <td>
                                <span
                                    class="font-mono text-sm font-bold text-[#2563eb]">#{{demande.numeroDossier}}</span>
                            </td>
                            <td>
                                <div class="flex items-center gap-3">
                                    <div class="avatar-premium" [style.background]="getAvatarColor(i)">
                                        {{getInitials(demande.etudiant.nom, demande.etudiant.prenom)}}
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-bold text-[#0f1117]">{{demande.etudiant.nom}}
                                            {{demande.etudiant.prenom}}</span>
                                        <span
                                            class="text-[11px] font-medium text-[#8b92a9]">{{demande.etudiant.email}}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-[#0f1117]">{{demande.nomDiplome}}</span>
                                    <span class="text-[10px] font-medium text-[#8b92a9] uppercase tracking-wider">1ère
                                        Année</span>
                                </div>
                            </td>
                            <td>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold"
                                        [class.text-[#dc2626]]="demande.priorite === 'HAUTE'">
                                        {{formatTime(demande.enAttenteDepuis)}}
                                    </span>
                                    <span class="text-[10px] font-bold"
                                        [class.text-[#dc2626]]="demande.priorite === 'HAUTE'"
                                        [class.text-[#d97706]]="demande.priorite === 'MOYENNE'"
                                        [class.text-[#2563eb]]="demande.priorite === 'BASSE'">
                                        {{getPrioriteLabel(demande.priorite)}}
                                    </span>
                                </div>
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <div *ngIf="areAllDocumentsSubmitted(demande.documents)"
                                        class="w-9 h-9 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 shadow-sm"
                                        title="Documents complets">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M5 13l4 4L19 7" />
                                        </svg>
                                    </div>
                                    <div *ngIf="!areAllDocumentsSubmitted(demande.documents)"
                                        class="w-9 h-9 rounded-full bg-rose-100 flex items-center justify-center text-rose-600 shadow-sm"
                                        title="Documents manquants">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </div>
                                    <span class="text-xs font-bold text-[#4a5068]">
                                        {{getDocumentsSoumisCount(demande.documents)}}/{{demande.documents.length}}
                                    </span>
                                </div>
                            </td>
                            <td class="text-right">
                                <div class="flex items-center justify-end gap-1">
                                    <button (click)="openDemandeDetail(demande)"
                                        class="p-2.5 text-[#4a5068] hover:text-[#2563eb] hover:bg-[#eff4ff] rounded-xl transition-all"
                                        title="Voir détails">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="2" />
                                            <path
                                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                                                stroke-width="2" />
                                        </svg>
                                    </button>
                                    <button
                                        (click)="$event.stopPropagation(); openDemandeDetail(demande, 'action', 'validation')"
                                        [disabled]="!areAllDocumentsSubmitted(demande.documents)"
                                        class="p-2.5 text-emerald-600 hover:bg-emerald-50 rounded-xl transition-all disabled:opacity-30 disabled:grayscale"
                                        title="Valider">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path d="M5 13l4 4L19 7" stroke-width="2.5" stroke-linecap="round" />
                                        </svg>
                                    </button>
                                    <button
                                        (click)="$event.stopPropagation(); openDemandeDetail(demande, 'action', 'rejet')"
                                        class="p-2.5 text-rose-600 hover:bg-rose-50 rounded-xl transition-all"
                                        title="Rejeter">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path d="M6 18L18 6M6 6l12 12" stroke-width="2.5" stroke-linecap="round" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr *ngIf="demandes.length === 0 && !loading">
                            <td colspan="6" class="py-20 text-center">
                                <div class="flex flex-col items-center justify-center space-y-4">
                                    <div
                                        class="w-16 h-16 bg-gray-50 rounded-2xl flex items-center justify-center text-gray-300">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                    </div>
                                    <div class="space-y-1">
                                        <p class="text-sm font-bold text-[#0f1117]">Aucun dossier trouvé</p>
                                        <p class="text-xs text-[#8b92a9] font-medium">Réessayez avec d'autres mots-clés
                                            ou filtres.</p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Grid View -->
            <div class="p-6" *ngIf="viewMode === 'grid'">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" *ngIf="demandes.length > 0">
                    <div *ngFor="let demande of demandes; let i = index" class="dossier-card animate-fadeIn"
                        [style.animation-delay]="i * 0.05 + 's'" (click)="openDemandeDetail(demande)">

                        <div class="flex items-center justify-between mb-4">
                            <span
                                class="font-mono text-[11px] font-bold text-[#2563eb] px-2 py-1 bg-[#eff4ff] rounded-lg">
                                #{{demande.numeroDossier}}
                            </span>
                            <span class="status-badge" [class.complet]="areAllDocumentsSubmitted(demande.documents)"
                                [class.incomplet]="hasMissingDocuments(demande.documents)"
                                [class.urgent]="demande.priorite === 'HAUTE'">
                                {{demande.priorite === 'HAUTE' ? 'Urgent' :
                                (areAllDocumentsSubmitted(demande.documents)
                                ? 'Complet' : 'À suivre')}}
                            </span>
                        </div>

                        <div class="flex items-center gap-3 mb-4">
                            <div class="avatar-premium" [style.background]="getAvatarColor(i)">
                                {{getInitials(demande.etudiant.nom, demande.etudiant.prenom)}}
                            </div>
                            <div class="flex flex-col min-w-0">
                                <span class="text-sm font-bold text-[#0f1117] truncate">{{demande.etudiant.nom}}
                                    {{demande.etudiant.prenom}}</span>
                                <span
                                    class="text-[11px] font-medium text-[#8b92a9] truncate">{{demande.nomDiplome}}</span>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div
                                class="flex items-center justify-between p-3 bg-[#f8fafc] rounded-xl border border-[#e2e8f0]">
                                <div class="flex items-center gap-2">
                                    <div *ngIf="areAllDocumentsSubmitted(demande.documents)"
                                        class="w-6 h-6 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M5 13l4 4L19 7" />
                                        </svg>
                                    </div>
                                    <div *ngIf="!areAllDocumentsSubmitted(demande.documents)"
                                        class="w-6 h-6 rounded-full bg-rose-100 flex items-center justify-center text-rose-600">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </div>
                                    <span class="text-xs font-bold text-[#0f1117]">Documents</span>
                                </div>
                                <span class="text-[11px] font-bold text-[#4a5068]">
                                    {{getDocumentsSoumisCount(demande.documents)}}/{{demande.documents.length}}
                                </span>
                            </div>
                        </div>

                        <div class="mt-4 pt-4 border-t border-[#e8eaf0] flex items-center justify-between">
                            <div class="flex flex-col">
                                <span
                                    class="text-[9px] font-bold text-[#8b92a9] uppercase tracking-wider">Attente</span>
                                <span
                                    class="text-xs font-bold text-[#0f1117]">{{formatTime(demande.enAttenteDepuis)}}</span>
                            </div>
                            <button
                                class="w-8 h-8 rounded-lg bg-[#f1f3f9] flex items-center justify-center text-[#4a5068] hover:bg-[#eff4ff] hover:text-[#2563eb] transition-all">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M9 5l7 7-7 7" stroke-width="2.5" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Grid View Empty State -->
                <div *ngIf="demandes.length === 0 && !loading"
                    class="py-20 text-center bg-white rounded-2xl border border-dashed border-[#e8eaf0] mx-6">
                    <div class="flex flex-col items-center justify-center space-y-4">
                        <div class="w-16 h-16 bg-gray-50 rounded-2xl flex items-center justify-center text-gray-300">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <div class="space-y-1">
                            <p class="text-sm font-bold text-[#0f1117]">Aucun dossier trouvé</p>
                            <p class="text-xs text-[#8b92a9] font-medium">Réessayez avec d'autres mots-clés ou filtres.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Global Pagination -->
            <div class="px-6 py-4 border-t border-[#e8eaf0] flex items-center justify-between bg-white/50"
                *ngIf="totalPages > 1 && !loading">
                <p class="text-[11px] font-bold text-[#8b92a9] uppercase tracking-wider">
                    Affichage de {{currentPage * pageSize + 1}} à {{Math.min((currentPage + 1) * pageSize,
                    totalElements)}} sur {{totalElements}} dossiers
                </p>
                <div class="flex items-center gap-2">
                    <button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 0"
                        class="p-2 border border-[#e8eaf0] rounded-lg hover:bg-[#f1f3f9] disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M15 19l-7-7 7-7" stroke-width="2.5" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button>

                    <div class="flex items-center gap-1">
                        <button *ngFor="let p of getPagesArray()" (click)="goToPage(p)"
                            class="w-8 h-8 rounded-lg text-xs font-bold transition-all"
                            [class.bg-[#2563eb]]="currentPage === p" [class.text-white]="currentPage === p"
                            [class.text-[#4a5068]]="currentPage !== p" [class.hover:bg-[#eff4ff]]="currentPage !== p">
                            {{p + 1}}
                        </button>
                    </div>

                    <button (click)="goToPage(currentPage + 1)" [disabled]="currentPage >= totalPages - 1"
                        class="p-2 border border-[#e8eaf0] rounded-lg hover:bg-[#f1f3f9] disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M9 5l7 7-7 7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal détail du dossier -->
    <!-- ═══════════════════════════════════════════════════════
     MODAL DÉTAIL DOSSIER — VERSION AMÉLIORÉE
     Remplace complètement l'ancien bloc *ngIf="showModal"
═══════════════════════════════════════════════════════ -->

    <div *ngIf="showModal && selectedDemande" class="modal-backdrop" (click)="closeModal()"
        (keydown.escape)="closeModal()">

        <div class="modal-shell" (click)="$event.stopPropagation()" [@modalAnim]>

            <!-- ══ SIDEBAR GAUCHE ══ -->
            <aside class="modal-sidebar">

                <!-- Avatar + Identité -->
                <div class="sidebar-identity">
                    <div class="identity-avatar" [style.background]="getAvatarColor(0)">
                        {{ getInitials(selectedDemande.etudiant.nom, selectedDemande.etudiant.prenom) }}
                        <span class="identity-avatar-ring"></span>
                    </div>
                    <div class="identity-meta">
                        <span class="dossier-tag">#{{ selectedDemande.numeroDossier }}</span>
                        <span *ngIf="selectedDemande.priorite === 'HAUTE'" class="urgent-tag">
                            <span class="urgent-dot"></span> Urgent
                        </span>
                    </div>
                    <h2 class="identity-name">
                        {{ selectedDemande.etudiant.prenom }}<br>{{ selectedDemande.etudiant.nom }}
                    </h2>
                </div>

                <!-- Progression documents -->
                <div class="sidebar-progress">
                    <div class="progress-label">
                        <span>Documents</span>
                        <span class="progress-count"
                            [class.count-ok]="areAllDocumentsSubmitted(selectedDemande.documents)"
                            [class.count-ko]="!areAllDocumentsSubmitted(selectedDemande.documents)">
                            {{ getDocumentsSoumisCount(selectedDemande.documents) }}/{{ selectedDemande.documents.length
                            }}
                        </span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill"
                            [class.fill-complete]="areAllDocumentsSubmitted(selectedDemande.documents)"
                            [style.width.%]="getCompletionPercentage(selectedDemande.documents)">
                        </div>
                    </div>
                    <p class="progress-status" [class.status-ok]="areAllDocumentsSubmitted(selectedDemande.documents)"
                        [class.status-ko]="!areAllDocumentsSubmitted(selectedDemande.documents)">
                        {{ areAllDocumentsSubmitted(selectedDemande.documents) ? '✓ Dossier complet' : '⚠ Pièces
                        manquantes' }}
                    </p>
                </div>

                <!-- Workflow Stepper -->
                <div class="sidebar-stepper">
                    <p class="stepper-title">Workflow</p>
                    <div class="stepper-list">
                        <div class="stepper-step done">
                            <div class="step-dot"><svg viewBox="0 0 12 12" fill="none">
                                    <path d="M2 6l3 3 5-5" stroke="currentColor" stroke-width="1.8"
                                        stroke-linecap="round" />
                                </svg></div>
                            <div class="step-content">
                                <span class="step-name">Soumis</span>
                                <span class="step-date">{{ selectedDemande.dateCreation | date:'dd/MM' }}</span>
                            </div>
                        </div>
                        <div class="stepper-connector done-line"></div>
                        <div class="stepper-step" [class.done]="isStepDone('SCOLARITE')"
                            [class.active]="isStepActive('SCOLARITE')">
                            <div class="step-dot">
                                <svg *ngIf="isStepDone('SCOLARITE')" viewBox="0 0 12 12" fill="none">
                                    <path d="M2 6l3 3 5-5" stroke="currentColor" stroke-width="1.8"
                                        stroke-linecap="round" />
                                </svg>
                                <span *ngIf="!isStepDone('SCOLARITE')"></span>
                            </div>
                            <div class="step-content">
                                <span class="step-name">Scolarité</span>
                                <span class="step-date">En cours</span>
                            </div>
                        </div>
                        <div class="stepper-connector" [class.done-line]="isStepDone('DEPARTEMENT')"></div>
                        <div class="stepper-step" [class.done]="isStepDone('DEPARTEMENT')">
                            <div class="step-dot">
                                <svg *ngIf="isStepDone('DEPARTEMENT')" viewBox="0 0 12 12" fill="none">
                                    <path d="M2 6l3 3 5-5" stroke="currentColor" stroke-width="1.8"
                                        stroke-linecap="round" />
                                </svg>
                            </div>
                            <div class="step-content">
                                <span class="step-name">Département</span>
                                <span class="step-date">—</span>
                            </div>
                        </div>
                        <div class="stepper-connector"></div>
                        <div class="stepper-step">
                            <div class="step-dot"></div>
                            <div class="step-content">
                                <span class="step-name">Paiement</span>
                                <span class="step-date">—</span>
                            </div>
                        </div>
                        <div class="stepper-connector"></div>
                        <div class="stepper-step">
                            <div class="step-dot"></div>
                            <div class="step-content">
                                <span class="step-name">Inscrit</span>
                                <span class="step-date">—</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Infos contact -->
                <div class="sidebar-contact">
                    <div class="contact-row">
                        <svg viewBox="0 0 20 20" fill="none">
                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"
                                fill="currentColor" />
                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" fill="currentColor" />
                        </svg>
                        <span>{{ selectedDemande.etudiant.email }}</span>
                    </div>
                    <div class="contact-row" *ngIf="selectedDemande.etudiant.telephone">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path
                                d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                        </svg>
                        <span>{{ selectedDemande.etudiant.telephone }}</span>
                    </div>
                    <div class="contact-row">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path
                                d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z" />
                        </svg>
                        <span>{{ selectedDemande.nomDiplome }}</span>
                    </div>
                </div>

                <!-- Bouton fermer (sidebar) -->
                <button class="sidebar-close" (click)="closeModal()">
                    <svg viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </aside>

            <!-- ══ ZONE PRINCIPALE ══ -->
            <main class="modal-main">

                <!-- Onglets -->
                <nav class="modal-tabs">
                    <button class="modal-tab" [class.tab-active]="activeTab === 'documents'"
                        (click)="activeTab = 'documents'">
                        <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"
                                clip-rule="evenodd" />
                        </svg>
                        Documents
                        <span class="tab-badge"
                            [class.badge-green]="areAllDocumentsSubmitted(selectedDemande.documents)"
                            [class.badge-red]="!areAllDocumentsSubmitted(selectedDemande.documents)">
                            {{ getDocumentsSoumisCount(selectedDemande.documents) }}/{{ selectedDemande.documents.length
                            }}
                        </span>
                    </button>
                    <button class="modal-tab" [class.tab-active]="activeTab === 'action'"
                        (click)="activeTab = 'action'">
                        <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                clip-rule="evenodd" />
                        </svg>
                        Décision
                    </button>
                </nav>

                <!-- ── TAB : DOCUMENTS ── -->
                <div class="modal-body" *ngIf="activeTab === 'documents'">

                    <!-- Alerte dossier incomplet -->
                    <div class="incomplete-banner" *ngIf="!areAllDocumentsSubmitted(selectedDemande.documents)">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                clip-rule="evenodd" />
                        </svg>
                        <div>
                            <strong>Dossier incomplet</strong>
                            <p>{{ selectedDemande.documents.length - getDocumentsSoumisCount(selectedDemande.documents)
                                }} pièce(s) manquante(s). Demandez-les avant toute validation.</p>
                        </div>
                    </div>

                    <!-- Liste documents -->
                    <div class="doc-list">
                        <div class="doc-item-v2" *ngFor="let doc of selectedDemande.documents; let i = index"
                            [class.doc-ok]="doc.statut === 'SOUMIS'" [class.doc-ko]="doc.statut !== 'SOUMIS'"
                            [style.animation-delay]="i * 0.06 + 's'">

                            <!-- Icône statut -->
                            <div class="doc-icon-wrap" [class.icon-ok]="doc.statut === 'SOUMIS'"
                                [class.icon-ko]="doc.statut !== 'SOUMIS'">
                                <svg *ngIf="doc.statut === 'SOUMIS'" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                <svg *ngIf="doc.statut !== 'SOUMIS'" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>

                            <!-- Infos -->
                            <div class="doc-info">
                                <p class="doc-type">{{ doc.type }}</p>
                                <p class="doc-filename" *ngIf="doc.nomFichier">{{ doc.nomFichier }}</p>
                                <p class="doc-missing" *ngIf="doc.statut !== 'SOUMIS'">Non soumis</p>
                            </div>

                            <!-- Statut pill -->
                            <span class="doc-status-pill" [class.pill-ok]="doc.statut === 'SOUMIS'"
                                [class.pill-ko]="doc.statut !== 'SOUMIS'">
                                {{ doc.statut === 'SOUMIS' ? 'Soumis' : 'Manquant' }}
                            </span>

                            <!-- Actions -->
                            <div class="doc-actions" *ngIf="doc.statut === 'SOUMIS'">
                                <button class="doc-btn btn-view" (click)="viewDocument(doc.documentId, doc.nomFichier)"
                                    title="Visualiser">
                                    <svg viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                        <path fill-rule="evenodd"
                                            d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <button class="doc-btn btn-dl" (click)="downloadDocument(doc.documentId)"
                                    title="Télécharger">
                                    <svg viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Bouton demander pièces -->
                    <button class="btn-demander-pieces" (click)="activeTab = 'action'; openDemanderPiecesDialog()"
                        *ngIf="!areAllDocumentsSubmitted(selectedDemande.documents)">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                        </svg>
                        Demander les pièces manquantes
                    </button>
                </div>

                <!-- ── TAB : DÉCISION ── -->
                <div class="modal-body" *ngIf="activeTab === 'action'">

                    <!-- Sélecteur d'action -->
                    <div class="action-selector"
                        *ngIf="!showValidationDialog && !showRejetDialog && !showDemanderPiecesDialog">

                        <!-- Bloc validation -->
                        <div class="action-card"
                            [class.action-card-disabled]="!areAllDocumentsSubmitted(selectedDemande.documents)"
                            (click)="areAllDocumentsSubmitted(selectedDemande.documents) && openValidationDialog()">
                            <div class="action-card-icon icon-green">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="action-card-body">
                                <h3>Valider le dossier</h3>
                                <p>Approuver et transmettre au département</p>
                            </div>
                            <svg class="action-card-arrow" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>

                        <div class="action-card action-card-red" (click)="openRejetDialog()">
                            <div class="action-card-icon icon-red">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="action-card-body">
                                <h3>Rejeter le dossier</h3>
                                <p>Notifier l'étudiant avec un motif</p>
                            </div>
                            <svg class="action-card-arrow" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>

                        <div class="action-card action-card-blue" (click)="openDemanderPiecesDialog()">
                            <div class="action-card-icon icon-blue">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div class="action-card-body">
                                <h3>Demander des pièces</h3>
                                <p>Envoyer une notification à l'étudiant</p>
                            </div>
                            <svg class="action-card-arrow" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>

                        <!-- Alerte dossier incomplet -->
                        <div class="incomplete-banner" *ngIf="!areAllDocumentsSubmitted(selectedDemande.documents)">
                            <svg viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            <div>
                                <strong>Validation désactivée</strong>
                                <p>Dossier incomplet — validez uniquement après réception de toutes les pièces.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Formulaire validation -->
                    <div class="action-form" *ngIf="showValidationDialog" [@formAnim]>
                        <div class="form-header form-header-green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div>
                                <h3>Confirmer la validation</h3>
                                <p>Dossier #{{ selectedDemande.numeroDossier }} · {{ selectedDemande.etudiant.nom }}</p>
                            </div>
                        </div>
                        <label class="form-label">Commentaire (optionnel)</label>
                        <textarea [(ngModel)]="commentaire" class="form-textarea"
                            placeholder="Message destiné à l'étudiant..." rows="4"></textarea>
                        <div class="form-actions">
                            <button class="btn-back" (click)="showValidationDialog = false">← Retour</button>
                            <button class="btn-confirm btn-confirm-green" (click)="validerDossier()"
                                [disabled]="actionLoading">
                                <span *ngIf="actionLoading" class="btn-spinner"></span>
                                {{ actionLoading ? 'Traitement...' : 'Confirmer la validation' }}
                            </button>
                        </div>
                    </div>

                    <!-- Formulaire rejet -->
                    <div class="action-form" *ngIf="showRejetDialog" [@formAnim]>
                        <div class="form-header form-header-red">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div>
                                <h3>Motif de rejet</h3>
                                <p>Ce message sera envoyé à l'étudiant</p>
                            </div>
                        </div>
                        <label class="form-label">Motif <span class="required">*</span></label>
                        <textarea [(ngModel)]="commentaire" class="form-textarea"
                            placeholder="Expliquez clairement la raison du rejet..." rows="4"></textarea>
                        <p class="form-hint" *ngIf="!commentaire.trim()">Un motif est obligatoire pour rejeter un
                            dossier.</p>
                        <div class="form-actions">
                            <button class="btn-back" (click)="showRejetDialog = false">← Retour</button>
                            <button class="btn-confirm btn-confirm-red" (click)="rejeterDossier()"
                                [disabled]="actionLoading || !commentaire.trim()">
                                <span *ngIf="actionLoading" class="btn-spinner"></span>
                                {{ actionLoading ? 'Traitement...' : 'Confirmer le rejet' }}
                            </button>
                        </div>
                    </div>

                    <!-- Formulaire demander pièces -->
                    <div class="action-form" *ngIf="showDemanderPiecesDialog" [@formAnim]>
                        <div class="form-header form-header-blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            <div>
                                <h3>Demander des pièces</h3>
                                <p>Notification envoyée par email à l'étudiant</p>
                            </div>
                        </div>
                        <label class="form-label">Pièces demandées <span class="required">*</span></label>
                        <textarea [(ngModel)]="commentaire" class="form-textarea"
                            placeholder="Ex: Copie de la CIN, relevé de notes L2..." rows="4"></textarea>
                        <div class="form-actions">
                            <button class="btn-back" (click)="showDemanderPiecesDialog = false">← Retour</button>
                            <button class="btn-confirm btn-confirm-blue" (click)="demanderPieces()"
                                [disabled]="!commentaire.trim()">
                                Envoyer la demande
                            </button>
                        </div>
                    </div>

                </div>

            </main>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════════
     VIEWER DOCUMENT (inchangé fonctionnellement, design amélioré)
═══════════════════════════════════════════════ -->
    <div *ngIf="showDocumentViewer" class="viewer-backdrop" (click)="closeDocumentViewer()">
        <div class="viewer-shell" (click)="$event.stopPropagation()">

            <div class="viewer-header">
                <div class="viewer-title">
                    <div class="viewer-icon">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div>
                        <h3>{{ currentDocumentName }}</h3>
                        <p>Aperçu du document</p>
                    </div>
                </div>
                <div class="viewer-actions">
                    <a [href]="currentDocumentUrl | safe: 'resourceUrl'" [download]="currentDocumentName"
                        class="viewer-btn-dl">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                        Télécharger
                    </a>
                    <button class="viewer-btn-close" (click)="closeDocumentViewer()">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="viewer-body">
                <iframe [src]="currentDocumentUrl | safe: 'resourceUrl'" class="viewer-iframe"
                    *ngIf="currentDocumentUrl"></iframe>
            </div>
        </div>
    </div>
    <div class="modal-toast" [class.toast-show]="toastVisible" [class.toast-success]="toastType === 'success'"
        [class.toast-error]="toastType === 'error'">
        {{ toastMessage }}
    </div>